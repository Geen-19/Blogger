name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-test:
    name: Lint • Typecheck • Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true

    # ✅ Make env available to ALL steps (including build)
    env:
      NODE_ENV: production
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Kinde auth – required at build time
      KINDE_ISSUER_URL: ${{ secrets.KINDE_ISSUER_URL }}
      KINDE_CLIENT_ID: ${{ secrets.KINDE_CLIENT_ID }}
      KINDE_CLIENT_SECRET: ${{ secrets.KINDE_CLIENT_SECRET }}
      KINDE_SITE_URL: ${{ secrets.KINDE_SITE_URL }}
      KINDE_REDIRECT_URL: ${{ secrets.KINDE_REDIRECT_URL }}
      KINDE_POST_LOGIN_REDIRECT_URL: ${{ secrets.KINDE_POST_LOGIN_REDIRECT_URL }}
      KINDE_POST_LOGOUT_REDIRECT_URL: ${{ secrets.KINDE_POST_LOGOUT_REDIRECT_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Prisma generate
        run: npx prisma generate
        # (no per-step env needed since it's set at the job level)

      - name: Typecheck
        run: npm run typecheck --if-present

      - name: Build
        run: npm run build
